# P5-05: REST Endpoints (send, stream, agents, health)

## Goal

Add REST API endpoints to the Gateway alongside the existing WebSocket
server, enabling cross-platform client integration.

## Depends On

P5-04 (protocol types with ToSchema), P3-05 (axum WebSocket server),
P3-08 (Gateway binary with AppState).

## Design Decisions

- REST router mounted at `/v1/` prefix, merged with existing axum router.
- `POST /v1/send` — accepts `SendRequest` JSON body, returns
  `MessageResponse` JSON. Auth via Bearer token in Authorization header.
- `POST /v1/stream` — accepts `StreamRequest` JSON body, returns SSE
  stream (`text/event-stream`). Each event is a JSON `StreamChunk`.
  Final event has `done: true`. Uses `axum::response::sse::Sse`.
- `GET /v1/agents` — returns JSON array of `AgentInfo` for all registered
  agents. No auth required (public metadata).
- `GET /v1/agents/:id` — returns single `AgentInfo` or 404.
- `GET /health` — returns `HealthResponse` with status and version.
- All handlers annotated with `#[utoipa::path(...)]` for OpenAPI generation.
- Auth middleware: extract Bearer token, call Authenticator, create Session
  with scope Main. Reuses the same Authenticator as WebSocket.
- SSE streaming reuses `runtime.stream()` — same code path as WebSocket
  streaming but output wrapped in SSE Event format.

## Files

- **CREATE** `app/gateway/src/rest.rs` — REST router, handlers, auth middleware
- **MODIFY** `app/gateway/src/lib.rs` — add mod rest, re-export router builder
- **MODIFY** `app/gateway/Cargo.toml` — add utoipa, utoipa-axum deps; enable
  protocol openapi feature

## Tests

- `rest_send_returns_response` — POST /v1/send returns MessageResponse
- `rest_send_requires_auth` — missing token returns 401
- `rest_stream_returns_sse` — POST /v1/stream returns text/event-stream with
  chunks and a final done event
- `rest_agents_list` — GET /v1/agents returns registered agents
- `rest_agent_not_found` — GET /v1/agents/unknown returns 404
- `rest_health` — GET /health returns status ok

## Done When

- [ ] `cargo check --workspace` and `cargo test --workspace` pass
- [ ] REST endpoints respond correctly
- [ ] SSE streaming works for /v1/stream
- [ ] Auth consistent with WebSocket auth
