# P2-11: Wire Hybrid BM25 + Vector Recall

## Goal

Complete the recall pipeline in walrus-sqlite by wiring the existing Embedder
trait into `store()` and adding cosine similarity scoring alongside BM25 in
`recall_sync()`. No concrete embedder impl — the architecture is ready for
one to be plugged in later.

## Depends On

P2-09 (simplified runtime API). Independent of P2-10 (examples).

## Design Decisions

- `Memory::store()` calls `self.embedder.embed(value)` when an embedder is
  attached, then delegates to `store_with_metadata()` with the resulting
  vector. When no embedder is present, stores without embedding (current
  behavior).
- `recall_sync()` gains a two-path scoring strategy:
  - **BM25 path** (always): FTS5 MATCH as today.
  - **Vector path** (when embeddings exist): embed the query via
    `self.embedder.embed(query)`, compute cosine similarity against stored
    embeddings, produce a separate candidate list.
  - **Score fusion**: Reciprocal Rank Fusion (RRF) merges both ranked lists.
    `score = 1/(k + rank_bm25) + 1/(k + rank_vector)` with k=60 (standard).
    Falls back to BM25-only when no embedder or no stored embeddings.
- MMR re-ranking switches from Jaccard (text) to cosine (vectors) when
  embeddings are available, keeping Jaccard as fallback.
- Add `cosine_similarity(a: &[f32], b: &[f32]) -> f64` to `utils.rs`.
- `recall_sync` becomes `async` internally (or uses a sync wrapper) since
  `embed()` is async. Simplest: call `embed` in the `recall()` async method,
  pass the query embedding into `recall_sync` as `Option<Vec<f32>>`.

## Files

- **MODIFY** `crates/sqlite/src/memory.rs` — `store()` calls embedder,
  `recall()` embeds query and passes to `recall_sync`
- **MODIFY** `crates/sqlite/src/lib.rs` — `recall_sync` accepts optional
  query embedding, adds vector scoring + RRF fusion, cosine MMR
- **MODIFY** `crates/sqlite/src/utils.rs` — add `cosine_similarity()`
- **CREATE** `crates/sqlite/sql/recall_vector.sql` — SELECT with embedding
  for brute-force cosine scan (small memory stores don't need ANN)
- **MODIFY** `crates/sqlite/tests/sqlite.rs` — hybrid recall tests

## Tests

- `recall_bm25_only_unchanged` — no embedder, same results as before
- `recall_with_embeddings_fuses_scores` — mock embedder, verify RRF fusion
- `store_auto_embeds_when_embedder_present` — verify embedding stored
- `store_no_embed_when_no_embedder` — verify no embedding without embedder
- `cosine_similarity_unit` — basic vector math
- `mmr_uses_cosine_when_embeddings_available` — verify cosine over Jaccard

## Done When

- [ ] `cargo check --workspace` and `cargo clippy --workspace` pass
- [ ] `cargo test --workspace` passes
- [ ] BM25-only recall unchanged when no embedder attached
- [ ] Hybrid recall works with mock embedder in tests
