# P3-03: Session Management

## Goal

Implement session tracking for the Gateway with scoped trust levels and
lifecycle management.

## Depends On

P3-01 (Gateway skeleton).

## Design Decisions

- Session struct: id (`Uuid`), agent_id (`CompactString`), scope
  (`SessionScope`), trust_level (`TrustLevel`), created_at
  (`std::time::Instant`).
- SessionScope enum: Main, Dm, Group, Cron. Determines tool access
  restrictions per DD#8 and DD#9.
- TrustLevel enum: Full, Restricted. Main and Cron scopes get Full;
  Dm and Group get Restricted.
- SessionManager: `create(agent_id, scope) -> Session`,
  `get(id) -> Option<&Session>`, `remove(id)`,
  `cleanup_expired(max_age: Duration)`.
- In-memory storage via `BTreeMap<Uuid, Session>` for v1. No persistence.
- SessionManager is `Send + Sync` (interior mutability not needed — Gateway
  holds `&mut` during request handling).

## Files

- **CREATE** `app/gateway/src/session.rs` — Session, SessionScope,
  TrustLevel, SessionManager
- **MODIFY** `app/gateway/src/lib.rs` — add mod session, re-export types

## Tests

- `session_create_and_get` — create session, retrieve by id
- `session_remove` — remove session, verify get returns None
- `session_scope_trust_level` — verify Main/Cron → Full, Dm/Group → Restricted
- `session_cleanup_expired` — verify old sessions removed

## Done When

- [ ] `cargo check --workspace` and `cargo test --workspace` pass
- [ ] Sessions track scope and trust level
- [ ] Expired sessions cleaned up correctly
