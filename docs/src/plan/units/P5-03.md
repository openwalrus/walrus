# P5-03: Workspace-aware GatewayConfig Loading

## Goal

Extend GatewayConfig loading to support workspace directories: discover
agent/mcp/cron configs from subdirectories and merge with walrus.toml.

## Depends On

P5-01 (WorkspaceConfig types).

## Design Decisions

- `GatewayConfig::from_workspace(workspace: &WorkspaceConfig)` loads the
  root `walrus.toml` then discovers configs from subdirectories.
- Agent discovery: read all `.toml` files in `agents/`, deserialize each
  as an AgentConfig, append to `config.agents`.
- MCP discovery: read all `.toml` files in `mcp/`, deserialize each as
  McpServerConfig, append to `config.mcp_servers`.
- Cron discovery: read all `.toml` files in `cron/`, deserialize each as
  CronJobConfig, append to `config.cron_jobs`.
- Skills: `config.skills.directory` defaults to `skills/` relative to
  workspace root. SkillRegistry loads from there.
- Memory: `config.memory.path` defaults to `data/memory.db` relative to
  workspace root when backend is sqlite.
- Inline configs in `walrus.toml` (`[[agents]]`, `[[mcp_servers]]`,
  `[[cron_jobs]]`) are merged with directory-discovered ones. Directory
  configs take priority on name conflicts.
- The existing `GatewayConfig::from_file(path)` still works for single-file
  mode. `from_workspace` is the new path used when a workspace is detected.

## Files

- **MODIFY** `app/gateway/src/workspace.rs` — add from_workspace loading
- **MODIFY** `app/gateway/src/lib.rs` — update GatewayConfig with from_workspace
- **MODIFY** `app/gateway/src/bin/main.rs` — at startup, before MemoryBackend
  construction: try `WorkspaceConfig::discover()`, if found call
  `GatewayConfig::from_workspace()`, otherwise fall back to single-file loading

## Tests

- `from_workspace_merges_agents` — agents/ files merged into config
- `from_workspace_merges_mcp` — mcp/ files merged into config
- `from_workspace_defaults_memory_path` — memory.db path resolved relative
- `inline_and_directory_merge` — both sources combined, dir wins on conflict
- `fallback_to_single_file` — works when no workspace structure exists

## Done When

- [ ] `cargo check --workspace` and `cargo test --workspace` pass
- [ ] Gateway loads full config from workspace directory
- [ ] Single-file mode still works as fallback
