# P3-04: Authenticator Trait and ApiKeyAuthenticator

## Goal

Define the authentication interface and provide an API-key-based
implementation for the Gateway.

## Depends On

P3-03 (Session — uses TrustLevel in AuthContext).

## Design Decisions

- Authenticator trait with single async method: `authenticate(token: &str)
  -> Result<AuthContext>`. Uses RPITIT (no dyn dispatch, per DD#11).
- AuthContext struct: user_id (`CompactString`), trust_level (`TrustLevel`).
- ApiKeyAuthenticator: holds a `BTreeMap<CompactString, AuthContext>` mapping
  API keys to their contexts. Loaded from GatewayConfig at startup.
- Unknown or empty tokens return an error. No fallback to anonymous.
- Authenticator is generic — Gateway parameterized over it if needed later.
  For v1, ApiKeyAuthenticator used directly (no trait object).

## Files

- **CREATE** `app/gateway/src/auth.rs` — Authenticator trait, AuthContext,
  ApiKeyAuthenticator
- **MODIFY** `app/gateway/src/lib.rs` — add mod auth, re-export types

## Tests

- `api_key_auth_valid` — known key returns correct AuthContext
- `api_key_auth_invalid` — unknown key returns error
- `api_key_auth_empty` — empty token returns error

## Done When

- [ ] `cargo check --workspace` and `cargo test --workspace` pass
- [ ] Authenticator trait uses RPITIT (no dyn)
- [ ] ApiKeyAuthenticator validates keys from config
