# P4-05: CLI Interactive Chat REPL with Streaming

## Goal

Implement the interactive chat REPL for `walrus chat`. Supports streaming
token display and persistent history.

## Depends On

P4-04.

## Design Decisions

- ChatRepl struct holds a DirectRunner (generalized to Runner trait in P4-06),
  agent name, and Chat session.
- `stream_to_terminal()` is a standalone async function that consumes
  `impl Stream<Item = Result<StreamChunk>>` and writes tokens to stdout.
  Testable by passing a `Vec<u8>` writer.
- Uses rustyline for line input with persistent history at `~/.walrus/history`.
- Ctrl+C cancels current stream. Ctrl+D exits the REPL.
- Uses `dirs` crate for `~/.walrus/` config directory.
- `crossterm` for raw terminal control during streaming output.

## Files

- **CREATE** `app/cli/src/repl.rs` — ChatRepl, stream_to_terminal
- **MODIFY** `app/cli/Cargo.toml` — add rustyline, crossterm, dirs
- **MODIFY** `app/cli/src/lib.rs` — add mod repl
- **MODIFY** `app/cli/src/bin/main.rs` — wire Chat subcommand to ChatRepl

## Tests

- `stream_to_terminal_collects_tokens` — verify output from a mock stream
- `repl_history_dir` — verify history path uses dirs crate

## Done When

- [ ] `cargo check --workspace` passes
- [ ] `walrus chat` enters interactive REPL
- [ ] Streaming tokens display in real time
- [ ] History persists across sessions
