# P3-05: WebSocket Server

## Goal

Implement the axum-based WebSocket server that authenticates connections,
dispatches messages to Runtime, and streams responses back.

## Depends On

P3-01 (Gateway), P3-02 (Protocol types), P3-03 (Session), P3-04 (Auth).

## Design Decisions

- Axum router with `/ws` upgrade endpoint. Handler extracts
  `WebSocketUpgrade` and shared state via `State<Arc<AppState<M>>>`.
- `AppState<M: Memory>` holds Gateway reference (with Runtime, SessionManager,
  Authenticator) plus a tokio broadcast channel for shutdown signaling.
- Auth before upgrade: extract Bearer token from `Authorization` header,
  call authenticator. Return 401 if invalid. Only upgrade on success.
- After upgrade: first message must be ClientMessage::Authenticate.
  On success, create Session and send ServerMessage::Authenticated.
- SendMessage: call `runtime.send()`, return ServerMessage::MessageResponse.
- StreamMessage: call `runtime.stream()`, forward each StreamChunk as
  ServerMessage::StreamChunk with done=false, then final chunk with
  done=true.
- Socket split into sender/receiver. Sender runs in a spawned task reading
  from an mpsc channel. Receiver loop decodes ClientMessage and dispatches.
- All protocol messages are JSON over WebSocket Text frames.

## Files

- **CREATE** `app/gateway/src/ws.rs` — router, upgrade handler, message
  loop, `AppState<M>`
- **MODIFY** `app/gateway/src/lib.rs` — add mod ws, re-export router builder
- **MODIFY** `app/gateway/Cargo.toml` — add axum, protocol dependencies

## Tests

- `ws_auth_required` — connection without token gets 401
- `ws_authenticate_message` — valid Authenticate message creates session
- `ws_send_message_format` — verify ServerMessage::MessageResponse shape

## Done When

- [ ] `cargo check --workspace` and `cargo test --workspace` pass
- [ ] WebSocket upgrades with authentication
- [ ] Messages dispatched to Runtime and responses streamed back
