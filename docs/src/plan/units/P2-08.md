# P2-08: Hook Trait, Compaction, Ergonomic API

## Goal

Introduce a `Hook` trait for type-level runtime configuration, replace the
old Compactor with automatic LLM-driven compaction, and add ergonomic API
(re-exports, prelude, convenience constructors).

## Depends On

P2-07 (team delegation).

## Design Decisions

- Hook is a pure trait (no `&self`): `type Memory`, `fn compact()`, `fn flush()`.
  Defined in walrus-runtime, not walrus-core.
- `Runtime<H: Hook = InMemory>` holds `Arc<H::Memory>`. No Hook instance.
- `impl Hook for InMemory` with default prompts. SqliteMemory deferred (orphan rule).
- Old Compactor removed. `maybe_compact()` auto-triggers at 80% context:
  memory flush via silent LLM turn with "remember" tool, then LLM summary.
- Default prompts in `crates/runtime/prompts/` embedded via `include_str!`.
- MCP bridge stored as `Option<Arc<McpBridge>>` with `connect_mcp()` setter.
- `set_skills()` mutable setter alongside `with_skills()` builder.
- `Provider::deepseek(key)` convenience factory.
- Chat gains `compaction_count`, `len()`, `is_empty()`, `last_message()`.
- Re-exports from llm/core, `prelude` module.

## Files

- **CREATE** `crates/runtime/src/hook.rs` — Hook trait, default constants, `impl Hook for InMemory`
- **CREATE** `crates/runtime/prompts/compact.md` — default compaction prompt
- **CREATE** `crates/runtime/prompts/flush.md` — default flush prompt
- **MODIFY** `crates/runtime/src/lib.rs` — `Runtime<H: Hook>`, `maybe_compact()`, re-exports, prelude
- **MODIFY** `crates/runtime/src/chat.rs` — `compaction_count`, helpers
- **MODIFY** `crates/runtime/src/team.rs` — `H: Hook` generic
- **MODIFY** `crates/runtime/src/provider.rs` — `Provider::deepseek()`

## Tests

- `hook_default_compact_prompt` — InMemory returns non-empty compact prompt
- `hook_default_flush_prompt` — InMemory returns non-empty flush prompt
- `compaction_skips_below_threshold` — no compaction when under 80%
- `chat_compaction_count_default` — starts at 0
- `chat_helpers` — `len()`, `is_empty()`, `last_message()`
- `provider_deepseek_factory` — factory returns Ok
- `set_skills_on_existing_runtime` — mutable setter works

## Done When

- [x] `cargo check --workspace` and `cargo clippy --workspace` pass
- [x] `cargo test --workspace` passes (87 tests)
- [x] Runtime generic over Hook (not Memory)
- [x] Old Compactor removed, `maybe_compact()` wired in
- [x] Re-exports and prelude module available
