# P3-08: Gateway Binary Entry Point

## Goal

Wire all Gateway subsystems together into the binary entry point with
startup orchestration and graceful shutdown.

## Depends On

P3-05 (WebSocket server), P3-06 (Channel routing), P3-07 (Cron scheduler).

## Design Decisions

- Binary at `app/gateway/src/bin/main.rs` (replacing the stub from P3-01).
- Startup sequence: load TOML config, construct Provider, construct Memory
  from MemoryConfig (SqliteMemory or InMemory via MemoryBackend enum
  dispatch), start MCP servers, build Runtime, build Gateway, initialize
  subsystems.
- MemoryBackend enum: wraps InMemory and `SqliteMemory<NoEmbedder>` with
  Memory trait delegation (following Provider enum pattern, DD#22).
  Constructed from GatewayConfig's `[memory]` section.
- MCP server startup (DD#20): iterate config.mcp_servers, spawn each via
  `TokioChildProcess`, connect rmcp peer, register tools in McpBridge.
  McpBridge passed to Runtime before agent registration.
- Skills loading: call `SkillRegistry::load_dir()` with path from
  GatewayConfig's `[skills]` section.
- Initialize in order: MCP servers, SessionManager, Authenticator (from
  config keys), ChannelRouter (from config rules), CronScheduler (from
  config jobs), then bind the axum server.
- Axum server binds on `config.gateway.bind_address` (default `127.0.0.1:3000`).
- Channel listeners: start Telegram polling task if telegram config present.
  Each incoming event routed via ChannelRouter, dispatched to Runtime.
- Graceful shutdown: `tokio::signal::ctrl_c()` triggers a broadcast to all
  subsystems (WebSocket handler, cron scheduler, channel listeners).
  Server drains active connections before exit.
- Tracing subscriber initialized from `RUST_LOG` env var via
  `tracing-subscriber`.

## Files

- **MODIFY** `app/gateway/src/bin/main.rs` — full startup, server bind,
  shutdown orchestration
- **CREATE** `app/gateway/src/backend.rs` — MemoryBackend enum implementing Memory
- **MODIFY** `app/gateway/Cargo.toml` — add tracing-subscriber, tokio/signal

## Tests

- `config_loads_all_sections` — verify full config TOML parses correctly
- `default_bind_address` — verify default is 127.0.0.1:3000
- `memory_backend_from_config` — verify MemoryBackend constructs from MemoryConfig

## Done When

- [ ] `cargo check --workspace` and `cargo test --workspace` pass
- [ ] Binary starts, binds server, and shuts down cleanly on ctrl-c
- [ ] Memory backend selected from config (sqlite or inmemory)
- [ ] Skills loaded from configured directory
- [ ] All subsystems wired together
